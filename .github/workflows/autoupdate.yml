name: Choco Auto Update

on:
  schedule:
    - cron:  '0 0 * * *'
  workflow_dispatch:
    inputs:
      forced_packages:
        description: The list of packages to forcibly update (like "pkg1:ver1 pkg2")
        required: false

defaults:
  run:
    shell: pwsh

jobs:
  auto_update:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - name: Check a build environment
        run: |
          Get-CimInstance win32_operatingsystem -Property Caption, OSArchitecture, Version | fl Caption, OSArchitecture, Version
          $PSVersionTable
          git --version
          choco --version
          cmd /c "set" | grep -i 'github\|runner' | sort
      - name: Install Chocolatey Automatic Package Updater Module
        run: |
          Install-Module -Name Chocolatey-AU -Force
          Install-Module -Name Wormies-AU-Helpers -Force
      - name: Check update for packages
        run: |
          $ErrorActionPreference = 'Continue'
          ./update_all.ps1 -ForcedPackages '${{ github.event.inputs.forced_packages }}'
          7z a au_temp.zip $Env:TEMP\chocolatey\au\*
      - name: Upload update results
        uses: actions/upload-artifact@v4
        with:
          name: update_results
          path: |
            update_info.xml
            Update-AUPackages.md
            au_temp.zip
