name: Choco Auto Update

on:
  schedule:
    - cron:  '0 0 * * *'
  workflow_dispatch:
    inputs:
      forced_packages:
        description: The list of packages to forcibly update (like "pkg1:ver1 pkg2")
        required: false
jobs:
  auto_update:
    runs-on: ubuntu-latest
    container:
      image: chocolatey/choco:v2.5.1-linux
    permissions:
      contents: write  # push commits to a repository
    steps:
      - name: Install dependencies
        shell: bash
        run: |
          apt-get update
          apt-get install -y git wget p7zip-full msitools libimage-exiftool-perl
          wget -q https://github.com/PowerShell/PowerShell/releases/download/v7.2.22/powershell-lts_7.2.22-1.deb_amd64.deb
          dpkg -i powershell-lts_7.2.22-1.deb_amd64.deb
          rm powershell-lts_7.2.22-1.deb_amd64.deb
      - uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.TOKEN }}
          set-safe-directory: true
      - name: Configure Git
        shell: bash
        run: |
          git config --global --add safe.directory $(pwd)
          git config --global user.name "overag3"
          git config --global user.email "nicolas.rogier@univ-lorraine.fr"
          git config --global core.safecrlf false
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          echo "Git status check:"
          git status || echo "Git status failed"
          echo "Git remote check:"
          git remote -v || echo "Git remote failed"
      - name: Check a build environment
        shell: bash
        run: |
          echo "pwsh version: $(pwsh -Command '$PSVersionTable.PSVersion.ToString()')"
          echo "git version: $(git --version | awk '{print $3}')"
          echo "chocolatey version: $(choco --version)"
      - name: Install required modules
        shell: pwsh
        run: |
          Install-Module -Name Chocolatey-AU -Force -Repository PSGallery
          Install-Module -Name Wormies-AU-Helpers -Force
          Install-Module -Name AngleParse -Force
      - name: Check install of modules
        shell: pwsh
        run: |
          Get-Module -ListAvailable | Format-Table Name, Version, Path
      - name: Check update for packages
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          ./update_all.ps1 -ForcedPackages '${{ github.event.inputs.forced_packages }}'
          7z a au_temp.zip $Env:TEMP\chocolatey\au\*
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }} # To authenticate GitHub CLI
          au_Push: true
          # Github token to commit pushed packages to repository
          github_user_repo: ${{ github.repository }}
          github_api_key: ${{ secrets.TOKEN }}
          GIT_DISCOVERY_ACROSS_FILESYSTEM: 1
          # ID of the gist used to save run results - create a gist under the github_user (secret or not) and grab the id - https://gist.github.com/name/id
          # Optional, leave empty to create anonymous gist
          gist_id:

          # Force test: gist id for test results
          gist_id_test:

          # Chocolatey API key - to push updated packages
          api_key: ${{ secrets.APIKEY }}

          # GitHub Actions build url which points to this build
          GH_ACTIONS_BUILD_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      - name: Upload update results
        uses: actions/upload-artifact@v4
        with:
          name: update_results
          path: |
            update_info.xml
            Update-AUPackages.md
            au_temp.zip
